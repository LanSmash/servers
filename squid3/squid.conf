# This file is automatically generated by pfSense
# Do not edit manually !
#http_port 10.0.0.2:3128
http_port 3128 intercept
icp_port 7
#dns_v4_first off
#pid_filename /var/run/squid.pid
#cache_effective_user proxy
#cache_effective_group proxy
#error_default_language en
#icon_directory /usr/local/etc/squid/icons
visible_hostname proxy.ls
cache_mgr lansmash@lansmash.ls
#access_log /var/squid/logs/access.log
#cache_log /var/squid/logs/cache.log
#cache_store_log none
#sslcrtd_children 0
logfile_rotate 7

# default wait for 30seconds before terminating
shutdown_lifetime 3 seconds
# Allow local network(s) on interface(s)
acl localnet src  10.0.0.0/8 192.168.0.0/16

#uri_whitespace strip

cache_mem 32 MB
maximum_object_size_in_memory 32 KB
memory_replacement_policy heap GDSF
cache_replacement_policy heap LFUDA

# 95GB cache
cache_dir ufs /var/proxy/squid 97280 16 256
minimum_object_size 0 KB
maximum_object_size 10240000 KB
#offline_mode on
cache_swap_low 90
cache_swap_high 95
	
# Add any of your own refresh_pattern entries above these.
refresh_pattern ^ftp:    1440  20%  10080
refresh_pattern ^gopher:  1440  0%  1440
refresh_pattern -i (/cgi-bin/|\?) 0  0%  0
refresh_pattern .    0  20%  4320
# No redirector configured


#Remote proxies


# Setup some default acls
acl allsrc src all
acl localhost src 127.0.0.1/32
acl safeports port 21 70 80 210 280 443 488 563 591 631 777 901  3128 1025-65535 
acl sslports port 443 563  
acl manager proto cache_object
acl purge method PURGE
acl connect method CONNECT
acl HTTP proto HTTP
acl HTTPS proto HTTPS

http_access allow manager localhost
http_access deny manager
http_access allow purge localhost
http_access deny purge
http_access deny !safeports
http_access deny CONNECT !sslports

# Always allow localhost connections
http_access allow localhost

request_body_max_size 0 KB

#delay_pools 1
#delay_class 1 2
#delay_parameters 1 -1/-1 102400/102400
#delay_initial_bucket_level 100
#delay_access 1 allow allsrc

# Reverse Proxy settings


# Custom options
#log url terms after ?
strip_query_terms off

#Partial HTTP replies (206) can't be cached.  Used by Origin and Blizard.
#Set range offset limit to -1 to download a full file each time a partial is requested.
#Warning: This is will be a DOS style download as every part requested will trigger a full download by squid.
#probably better to scan access.log and download each url using wget.
#This method causes timeouts in blizzard downloader because it doesn't get data until the entire file has been downloaded (depending on requested range I think)
#range_offset_limit -1
#quick_abort_min -1

#quick_abort_min -1 KB
#quick_abort_max -1 KB

# pandonetworks is the p2p network for LoL downloader
acl blockurl_1 url_regex -i ^http://(.*)pandonetworks.com/(.*)$
http_access deny blockurl_1

# 20160 minutes is two weeks
# refresh_pattern -i (/cgi-bin/|\?) 0  0%  0
refresh_pattern -i (.*)blizzard.com(.*)  20160 100% 20160 refresh-ims
#reload-into-ims refresh-ims
refresh_pattern -i (.*)leagueoflegends.com(.*)  20160 100% 20160 refresh-ims
#reload-into-ims refresh-ims

#
# Only use cache peer for steam, etc downloads.
#
#acl steamddl  browser .*Valve.*

#acl steamddl url_regex http://.*/depot/.*/chunk/ /initsession/$ /authdepot/$
acl steam_ddl url_regex http://.*/depot/.*/chunk/
#acl blizzard_ddl url_regex http://dist.blizzard.com.edgesuite.net/ /sc2-pod-retail/
#acl origin_ddl url_regex akamai.cdn.ea.com

# don't cache steam or origin as it has not yet been rewritten to a generic url
# blizzard and origin use partial downloads so they won't cache.
cache deny steam_ddl 
#origin_ddl

####
# Peer definition
###

#cache_peer 10.0.0.2 parent 8080 7 no-query round-robin proxy-only #login=*:password no-delay

#no-delay to ensure steam downloads aren't counted in the users bandwidth
cache_peer steamproxypeer parent 82 0 no-query proxy-only no-delay no-digest

cache_peer_access steamproxypeer allow steam_ddl 
#origin_ddl blizzard_ddl

#Disable direct connection preference so peer is used when non positive hit.
#Will fall back to direct if peer unavailable
prefer_direct off

#prefer peer even if not optimal from content types
nonhierarchical_direct off


# Setup allowed acls
# Allow local network(s) on interface(s)
http_access allow localnet
http_access deny allsrc
